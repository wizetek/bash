#!/bin/bash
#
# redshifter
#
# Front end for 'redshift' from http://jonls.dk/redshift/
# Optionally bind actions to DM/WM keyboard shortcuts.
#
# 2018-03-13, 2020-03-20 Tom Wizetek
# GPL license

showHelp() {
echo << ENDHELP "
  redshifter [action] [brightness]

[action]
  -		decrease color temperature by 100K
  +		increase color temperature by 100K
  =		reset to default (but keep last value)
  1000-25000	set specific color temperature
  (blank)	cycle through presets:
		  6500K = Daylight
		  5500K = Sunlight
		  4200K = Fluorescent
		  3400K = Halogen
		  2700K = Incandescent
		  2300K = Dim Incandescent
		  1900K = Candle
		  1200K = Ember
  -h, --help	show this message

[brightness]
  0.1-1.0	set brightness

examples:

  redshifter 3800 0.6
  redshifter 9000
  redshifter -
"
ENDHELP
}

cmd_path="/usr/bin/redshift"
cmd_arg_temp="-P -O"
cmd_arg_brightness="-b"
cmd_arg_reset="-x -v"
temp_file="/tmp/$(basename ${0})-${UID}"
color_array=(6500 5500 4200 3400 2700 2300 1900 1200)
max_temp=${color_array[0]}
min_temp=${color_array[-1]}
set_brightness=1.0

if [[ -f ${temp_file} ]]
then
  read -r set_temp < ${temp_file}
else
  set_temp=${max_temp}
fi

if [[ -n ${2} ]]
then
  set_brightness=${2}
fi

case ${1} in
"-h"|"--help")
  showHelp
  exit 0
  ;;
"-")
  if [[ ${set_temp} -gt ${min_temp} ]]
  then
    ((set_temp-=100))
  fi
  ;;
"+")
  if [[ ${set_temp} -lt ${max_temp} ]]
  then
    ((set_temp+=100))
  fi
  ;;
"=")
  ${cmd_path} ${cmd_arg_reset}
  exit 0
  ;;
[0-9]*)
  set_temp=${1}
  ;;
*)
  for array_item in ${color_array[@]}
  do
    if [[ ${array_item} -lt ${set_temp} ]]
    then
      break
    # set_temp=1200, array_item=6500
    elif [[ ${set_temp} -eq ${min_temp} ]]
    then
      break
    fi
  done
  # Set temp from array
  set_temp=${array_item}
  ;;
esac

echo "color_temp=${set_temp}, brightness=${set_brightness}"
${cmd_path} ${cmd_arg_temp} ${set_temp} ${cmd_arg_brightness} ${set_brightness}
echo ${set_temp} > ${temp_file}

# eof
